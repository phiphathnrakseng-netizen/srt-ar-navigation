<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hybrid AR Navigation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }

        /* UI ‡∏ó‡∏∂‡∏ö‡πÅ‡∏™‡∏á 100% ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏•‡∏π‡∏Å‡∏®‡∏£ */
        #ui-header { position: fixed; top: 0; left: 0; width: 100%; height: 90px; background: #000; color: #fff; z-index: 10; display: none; flex-direction: column; justify-content: center; align-items: center; border-bottom: 2px solid #3b82f6; }
        #ui-footer { position: fixed; bottom: 0; left: 0; width: 100%; height: 140px; background: #000; color: #fff; z-index: 10; display: none; flex-direction: column; border-top: 2px solid #3b82f6; }
        
        .label { font-size: 0.7rem; color: #3b82f6; font-weight: bold; margin-bottom: 5px; }
        .target-name { font-size: 1.3rem; font-weight: bold; }
        .instruction { font-size: 1.5rem; font-weight: bold; text-align: center; padding: 0 15px; }
        #warning { background: #ff4444; font-size: 0.75rem; padding: 4px; width: 100%; text-align: center; }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å Hybrid */
        #entry-screen { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 20px; text-align: center; }
        .btn-group { background: #111; padding: 25px; border-radius: 20px; border: 1px solid #333; width: 85%; max-width: 320px; margin-bottom: 20px; }
        .main-btn { width: 100%; padding: 18px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; border: none; cursor: pointer; margin-top: 10px; color: white; }
        .scan-color { background: #3b82f6; }
        .manual-color { background: #444; }
    </style>
</head>
<body>

    <div id="entry-screen">
        <h1 style="color: #3b82f6; margin-bottom: 40px;">AR NAVIGATOR</h1>
        
        <div class="btn-group">
            <div class="label">‡πÇ‡∏´‡∏°‡∏î 1: ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≤‡∏¢ (‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô 1)</div>
            <button class="main-btn scan-color" onclick="startAR('scan')">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR Code</button>
        </div>

        <div class="btn-group">
            <div class="label">‡πÇ‡∏´‡∏°‡∏î 2: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏¢‡∏∑‡∏ô)</div>
            <button class="main-btn manual-color" onclick="startAR('manual', '3')">üìç ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏±‡πâ‡∏ô 3 (‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå)</button>
            <button class="main-btn manual-color" onclick="startAR('manual', '4')" style="margin-top: 15px;">üìç ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏±‡πâ‡∏ô 4 (‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå)</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="label">‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>
        <div id="target-display" class="target-name">-</div>
    </div>

    <div id="ui-footer">
        <div id="warning">‚ö†Ô∏è ‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠</div>
        <div style="flex:1; display:flex; align-items:center; justify-content:center;">
            <div id="guide-text" class="instruction">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-entity camera></a-entity>
        <a-entity id="arrow-pivot" position="0 -0.4 -2.5" visible="false">
            <a-cone radius-bottom="0.2" height="0.45" material="color: #3b82f6; emissive: #3b82f6; emissiveIntensity: 0.8;" rotation="90 0 0"></a-cone>
            <a-box position="0 -0.25 0" width="0.1" height="0.3" depth="0.1" material="color: #1e3a8a;"></a-box>
        </a-scene>
    </a-scene>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let initialAlpha = null;
        let targetRotY = 0;
        let lerpedRotY = 0;

        // ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        const db = {
            "floor3": { name: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 301", text: "üö∂ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤", angle: 90 },
            "floor4": { name: "‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö 405", text: "üö∂ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡πÑ‡∏õ", angle: 0 }
        };

        async function startAR(mode, floorChoice) {
            // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS/Android)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (e) { console.error(e); }
            }

            window.addEventListener('deviceorientation', (e) => {
                if (initialAlpha === null) initialAlpha = e.alpha;
                targetRotY = e.alpha - initialAlpha;
            });

            if (mode === 'manual') {
                const data = db["floor" + floorChoice];
                document.getElementById('target-display').innerText = data.name;
                document.getElementById('guide-text').innerText = data.text;
            } else {
                // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡πÅ‡∏Å‡∏ô: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL
                const t = urlParams.get('target') || "‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
                document.getElementById('target-display').innerText = t;
                document.getElementById('guide-text').innerText = "üö∂ ‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á " + t;
            }

            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ AR
            document.getElementById('entry-screen').style.display = 'none';
            document.getElementById('ui-header').style.display = 'flex';
            document.getElementById('ui-footer').style.display = 'flex';
            document.getElementById('arrow-pivot').setAttribute('visible', 'true');
            
            updateArrow();
        }

        function updateArrow() {
            let diff = targetRotY - lerpedRotY;
            while (diff < -180) diff += 360;
            while (diff > 180) diff -= 360;
            lerpedRotY += diff * 0.1; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏π‡∏ó‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏®‡∏£
            document.getElementById('arrow-pivot').object3D.rotation.y = THREE.MathUtils.degToRad(-lerpedRotY);
            requestAnimationFrame(updateArrow);
        }
    </script>
</body>
</html>
