<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Navigation - Fix Visibility</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Sarabun', sans-serif; background: #000; }

        /* ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô: ‡∏î‡∏≥‡∏ó‡∏∂‡∏ö ‡πÅ‡∏ï‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠ */
        #ui-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            background: #000; color: #fff; z-index: 10;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            border-bottom: 2px solid #3b82f6;
        }

        /* ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á: ‡∏î‡∏≥‡∏ó‡∏∂‡∏ö ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ã‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        #ui-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
            background: #000; color: #fff; z-index: 10;
            display: none; flex-direction: column;
            border-top: 2px solid #3b82f6;
        }

        #guidance-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #sensor-warning { background: #ffcc00; color: #000; padding: 5px; text-align: center; font-weight: 700; font-size: 0.85rem; }

        .label { font-size: 0.65rem; color: #3b82f6; text-transform: uppercase; letter-spacing: 1.5px; }
        .target { font-size: 1.2rem; font-weight: 700; }
        .step-text { font-size: 1.5rem; font-weight: 700; }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á A-Scene ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå UI */
        a-scene { position: absolute; top: 0; left: 0; z-index: 1; }

        #entry-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }
        .start-btn {
            background: #3b82f6; color: white; padding: 20px 40px;
            border-radius: 8px; font-size: 1.3rem; font-weight: 700; border: none;
        }
    </style>
</head>
<body>

    <div id="entry-screen">
        <button class="start-btn" onclick="initPrecisionAR()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (START)</button>
        <p style="margin-top:20px; opacity:0.7;">‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠</p>
    </div>

    <div id="ui-header">
        <div class="label">‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
        <div id="room-id" class="target">...</div>
    </div>

    <div id="ui-footer">
        <div id="guidance-content">
            <div class="label">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
            <span id="instruction-text" class="step-text">üö∂ ‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 10 ‡πÄ‡∏°‡∏ï‡∏£</span>
        </div>
        <div id="sensor-warning">
            ‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏£‡∏ß‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏≤‡∏° "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
        </div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-entity camera id="fixed-camera"></a-entity>
        
        <a-entity id="arrow-pivot" position="0 -0.5 -3" visible="false">
            <a-entity id="arrow-visual">
                <a-cone radius-bottom="0.25" height="0.5" material="color: #3b82f6; emissive: #3b82f6; emissiveIntensity: 1;" rotation="90 0 0"></a-cone>
                <a-box position="0 -0.3 0" width="0.12" height="0.4" depth="0.1" material="color: #1e3a8a;"></a-box>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById('room-id').innerText = urlParams.get('target') || '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';

        let initialAlpha = null;
        let targetRotY = 0;
        let lerpedRotY = 0;
        const smoothSpeed = 0.15;

        async function initPrecisionAR() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const res = await DeviceOrientationEvent.requestPermission();
                if (res === 'granted') window.addEventListener('deviceorientation', onDeviceMove);
            } else {
                window.addEventListener('deviceorientation', onDeviceMove);
            }
            showUI();
        }

        function onDeviceMove(event) {
            if (event.alpha === null) return;
            if (initialAlpha === null) initialAlpha = event.alpha;
            targetRotY = event.alpha - initialAlpha; 
        }

        function showUI() {
            document.getElementById('entry-screen').style.display = 'none';
            document.getElementById('ui-header').style.display = 'flex';
            document.getElementById('ui-footer').style.display = 'flex';
            document.getElementById('arrow-pivot').setAttribute('visible', 'true');
        }

        function animate() {
            let diff = targetRotY - lerpedRotY;
            while (diff < -180) diff += 360;
            while (diff > 180) diff -= 360;
            lerpedRotY += diff * smoothSpeed;

            const pivot = document.getElementById('arrow-pivot');
            if (pivot && pivot.getAttribute('visible')) {
                pivot.object3D.rotation.y = THREE.MathUtils.degToRad(-lerpedRotY);
            }
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
