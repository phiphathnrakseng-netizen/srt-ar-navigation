<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>ระบบนำทาง AR | นำทางไปยังเป้าหมาย</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --stc-navy-deep: #001A35;
            --stc-navy: #002D62;
            --stc-gold: #B8860B;
            --stc-silver: #E2E8F0;
            --stc-bg: #FFFFFF;
        }

        body { 
            font-family: 'Noto Sans Thai', sans-serif; 
            background-color: var(--stc-bg); 
            color: #1A1A1A;
            margin: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- AR View Container --- */
        #ar-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* --- Camera View --- */
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror for front camera */
        }

        /* --- Navigation Overlay --- */
        .navigation-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 29, 54, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* --- Step Counter UI --- */
        .step-counter-ui {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            border: 3px solid var(--stc-navy);
            min-width: 180px;
            backdrop-filter: blur(10px);
            animation: slideInRight 0.5s ease-out;
        }

        .step-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .step-count {
            font-size: 48px;
            font-weight: 900;
            color: var(--stc-navy);
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .step-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--stc-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .distance-display {
            background: var(--stc-navy);
            color: white;
            padding: 10px 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .distance-value {
            font-size: 24px;
            font-weight: 800;
        }

        .distance-label {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* --- Controls --- */
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .control-btn-primary {
            background: var(--stc-navy);
            color: white;
        }

        .control-btn-secondary {
            background: var(--stc-gold);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        /* --- Navigation Guide --- */
        .navigation-guide {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            border: 3px solid var(--stc-gold);
            backdrop-filter: blur(10px);
            animation: slideInUp 0.5s ease-out;
        }

        .guide-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .guide-icon {
            width: 40px;
            height: 40px;
            background: var(--stc-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .guide-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--stc-navy);
            flex: 1;
        }

        .guide-text {
            font-size: 16px;
            line-height: 1.5;
            color: #333;
            margin-bottom: 15px;
        }

        .progress-indicator {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--stc-gold), #ffd700);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        /* --- Compass --- */
        .compass {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border: 3px solid var(--stc-navy);
            backdrop-filter: blur(10px);
        }

        .compass-needle {
            width: 4px;
            height: 30px;
            background: #e53e3e;
            border-radius: 2px;
            position: absolute;
            top: 10px;
            transform-origin: bottom center;
            transition: transform 0.1s ease;
        }

        .compass-direction {
            position: absolute;
            bottom: 10px;
            font-size: 12px;
            font-weight: 800;
            color: var(--stc-navy);
        }

        /* --- Animations --- */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .step-pulse {
            animation: pulse 0.5s ease;
        }

        /* --- Responsive --- */
        @media (max-width: 480px) {
            .step-counter-ui {
                top: 10px;
                right: 10px;
                min-width: 150px;
                padding: 15px;
            }
            
            .step-count {
                font-size: 36px;
            }
            
            .navigation-guide {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .compass {
                top: 10px;
                left: 10px;
                width: 60px;
                height: 60px;
            }
        }

        /* --- Loading --- */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--stc-navy-deep);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="logo-container" style="width: 120px; height: 120px;">
            <img src="favicon.png" alt="STC Logo" onerror="this.src='https://upload.wikimedia.org/wikipedia/th/a/a2/Surat_Thani_Technical_College_Logo.png'">
        </div>
        <div class="loading-text" id="loading-text">กำลังเตรียมระบบนำทาง...</div>
    </div>

    <!-- AR View Container -->
    <div id="ar-container">
        <!-- Camera Feed -->
        <video id="camera-view" autoplay playsinline></video>
        
        <!-- Compass -->
        <div class="compass">
            <div class="compass-needle" id="compass-needle"></div>
            <div class="compass-direction" id="compass-direction">N</div>
        </div>

        <!-- Step Counter UI -->
        <div class="step-counter-ui">
            <div class="step-display">
                <div class="step-count" id="step-count">0</div>
                <div class="step-label">ก้าว</div>
            </div>
            
            <div class="distance-display">
                <div class="distance-value" id="distance-value">0.0</div>
                <div class="distance-label">ระยะทาง (เมตร)</div>
            </div>
            
            <div class="control-buttons">
                <button class="control-btn control-btn-primary" id="reset-btn">
                    <i class="fas fa-redo"></i> รีเซ็ต
                </button>
                <button class="control-btn control-btn-secondary" id="calibrate-btn">
                    <i class="fas fa-compass"></i> ตั้งศูนย์
                </button>
            </div>
        </div>

        <!-- Navigation Guide -->
        <div class="navigation-guide">
            <div class="guide-header">
                <div class="guide-icon">
                    <i class="fas fa-map-signs"></i>
                </div>
                <div class="guide-title" id="target-name">กำลังโหลด...</div>
                <div class="distance-value" id="remaining-distance">-</div>
            </div>
            
            <div class="progress-indicator">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="guide-text" id="guide-text">
                กำลังประมวลผลคำแนะนำการเดินทาง...
            </div>
            
            <div class="control-buttons">
                <button class="control-btn control-btn-primary" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> กลับหน้าหลัก
                </button>
                <button class="control-btn control-btn-secondary" id="voice-guide-btn">
                    <i class="fas fa-volume-up"></i> คำแนะนำเสียง
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== ระบบตรวจจับและนับก้าวเดิน ==========
        class StepCounterSystem {
            constructor() {
                this.stepCount = 0;
                this.totalDistance = 0;
                this.lastAcceleration = null;
                this.stepThreshold = 1.5; // ความไวในการตรวจจับก้าว
                this.isCounting = false;
                this.lastStepTime = 0;
                this.stepDebounce = 300; // เวลาระหว่างก้าว (ms)
                this.stepLength = 0.75; // ความยาวต่อก้าว (เมตร)
                this.calibrationSteps = 0;
                this.isCalibrating = false;
                
                // สำหรับเก็บประวัติการเคลื่อนไหว
                this.accelerationHistory = [];
                this.historySize = 10;
                
                // องค์ประกอบ UI
                this.stepCountElement = document.getElementById('step-count');
                this.distanceElement = document.getElementById('distance-value');
                this.resetButton = document.getElementById('reset-btn');
                this.calibrateButton = document.getElementById('calibrate-btn');
            }

            initialize() {
                console.log('Initializing Step Counter System...');
                
                // ตั้งค่าปุ่มควบคุม
                this.resetButton.addEventListener('click', () => this.reset());
                this.calibrateButton.addEventListener('click', () => this.startCalibration());
                
                // ตรวจสอบการรองรับเซ็นเซอร์
                this.checkSensorSupport();
            }

            checkSensorSupport() {
                if (typeof DeviceMotionEvent !== 'undefined') {
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                        // iOS 13+ - ต้องขออนุญาต
                        this.requestIOSPermission();
                    } else {
                        // Android และเบราว์เซอร์อื่นๆ
                        this.startMotionTracking();
                    }
                } else {
                    console.warn('Device Motion not supported, using simulation mode');
                    this.startSimulationMode();
                }
            }

            async requestIOSPermission() {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission === 'granted') {
                        console.log('Motion permission granted');
                        this.startMotionTracking();
                    } else {
                        console.warn('Motion permission denied');
                        this.startSimulationMode();
                    }
                } catch (error) {
                    console.error('Error requesting motion permission:', error);
                    this.startSimulationMode();
                }
            }

            startMotionTracking() {
                console.log('Starting motion tracking...');
                
                window.addEventListener('devicemotion', (event) => {
                    this.processMotionData(event);
                }, { passive: true });

                // เริ่มนับหลังจากเตรียมระบบเสร็จ
                setTimeout(() => {
                    this.isCounting = true;
                    console.log('Step counter activated');
                    this.updateLoadingText('ระบบตรวจจับก้าวพร้อมใช้งาน');
                }, 1000);
            }

            processMotionData(event) {
                if (!this.isCounting) return;

                const acceleration = event.accelerationIncludingGravity;
                if (!acceleration) return;

                // คำนวณความเร่งรวม
                const totalAcc = Math.sqrt(
                    Math.pow(acceleration.x || 0, 2) +
                    Math.pow(acceleration.y || 0, 2) +
                    Math.pow(acceleration.z || 0, 2)
                );

                // บันทึกประวัติความเร่ง
                this.accelerationHistory.push(totalAcc);
                if (this.accelerationHistory.length > this.historySize) {
                    this.accelerationHistory.shift();
                }

                const currentTime = Date.now();

                // ตรวจจับการก้าว
                if (this.lastAcceleration !== null && this.accelerationHistory.length >= 3) {
                    // คำนวณค่าเฉลี่ยเคลื่อนที่
                    const avgAcc = this.accelerationHistory.reduce((a, b) => a + b, 0) / this.accelerationHistory.length;
                    const delta = Math.abs(totalAcc - avgAcc);
                    
                    // ตรวจสอบเงื่อนไขการก้าว
                    if (delta > this.stepThreshold && 
                        (currentTime - this.lastStepTime) > this.stepDebounce &&
                        this.isValidStepPattern()) {
                        
                        this.registerStep(currentTime);
                    }
                }

                this.lastAcceleration = totalAcc;
            }

            isValidStepPattern() {
                // ตรวจสอบรูปแบบการก้าวที่ถูกต้อง
                if (this.accelerationHistory.length < 3) return false;
                
                const recent = this.accelerationHistory.slice(-3);
                const isPeak = recent[1] > recent[0] && recent[1] > recent[2];
                const magnitude = Math.max(...recent) - Math.min(...recent);
                
                return isPeak && magnitude > this.stepThreshold * 0.7;
            }

            registerStep(timestamp) {
                this.stepCount++;
                this.lastStepTime = timestamp;
                
                // คำนวณระยะทาง
                this.totalDistance = this.stepCount * this.stepLength;
                
                // อัพเดท UI
                this.updateDisplay();
                
                // ส่งอีเวนต์การก้าว
                this.dispatchStepEvent();
                
                // ถ้ากำลังปรับเทียบ
                if (this.isCalibrating) {
                    this.calibrationSteps++;
                    if (this.calibrationSteps >= 10) {
                        this.finishCalibration();
                    }
                }
            }

            updateDisplay() {
                // อัพเดทตัวนับก้าว
                if (this.stepCountElement) {
                    this.stepCountElement.textContent = this.stepCount;
                    this.stepCountElement.classList.add('step-pulse');
                    setTimeout(() => {
                        this.stepCountElement.classList.remove('step-pulse');
                    }, 500);
                }
                
                // อัพเดทระยะทาง
                if (this.distanceElement) {
                    this.distanceElement.textContent = this.totalDistance.toFixed(1);
                }
                
                // อัพเดทโปรเกรสในการนำทาง
                this.updateNavigationProgress();
            }

            updateNavigationProgress() {
                const params = new URLSearchParams(window.location.search);
                const targetDistance = parseFloat(params.get('dist')) || 200;
                const progress = Math.min((this.totalDistance / targetDistance) * 100, 100);
                
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                const remainingDistance = Math.max(targetDistance - this.totalDistance, 0);
                const remainingElement = document.getElementById('remaining-distance');
                if (remainingElement) {
                    remainingElement.textContent = remainingDistance.toFixed(1) + 'm';
                }
            }

            dispatchStepEvent() {
                // ส่ง Custom Event สำหรับส่วนอื่นๆ ของแอป
                const stepEvent = new CustomEvent('stepDetected', {
                    detail: {
                        count: this.stepCount,
                        distance: this.totalDistance,
                        timestamp: Date.now()
                    }
                });
                window.dispatchEvent(stepEvent);
            }

            startCalibration() {
                console.log('Starting calibration...');
                this.isCalibrating = true;
                this.calibrationSteps = 0;
                this.updateLoadingText('โปรดเดิน 10 ก้าวเพื่อปรับเทียบค่า...');
                
                // รีเซ็ตชั่วคราว
                const tempSteps = this.stepCount;
                const tempDistance = this.totalDistance;
                
                this.stepCount = 0;
                this.totalDistance = 0;
                this.updateDisplay();
                
                // ตั้งเวลา timeout ถ้าไม่ครบ 10 ก้าว
                setTimeout(() => {
                    if (this.isCalibrating) {
                        this.isCalibrating = false;
                        this.stepCount = tempSteps;
                        this.totalDistance = tempDistance;
                        this.updateDisplay();
                        this.updateLoadingText('การปรับเทียบถูกยกเลิก');
                    }
                }, 30000);
            }

            finishCalibration() {
                this.isCalibrating = false;
                const avgStepLength = 10 / this.calibrationSteps; // เมตรต่อก้าว
                this.stepLength = avgStepLength * 0.75; // ปรับค่าสำหรับการเดินปกติ
                
                console.log(`Calibration complete. Step length: ${this.stepLength.toFixed(3)}m`);
                this.updateLoadingText('ปรับเทียบสำเร็จ!');
                
                // แจ้งเตือนผู้ใช้
                if (window.navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            }

            reset() {
                this.stepCount = 0;
                this.totalDistance = 0;
                this.updateDisplay();
                
                // แจ้งเตือนรีเซ็ต
                if (window.navigator.vibrate) {
                    navigator.vibrate(100);
                }
                
                console.log('Step counter reset');
            }

            startSimulationMode() {
                console.log('Starting simulation mode');
                this.updateLoadingText('ใช้โหมดจำลอง (Simulation Mode)');
                
                // จำลองการก้าวทุก 1.5 วินาที
                setInterval(() => {
                    if (this.isCounting) {
                        this.registerStep(Date.now());
                    }
                }, 1500);
                
                this.isCounting = true;
            }

            updateLoadingText(text) {
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = text;
                }
            }

            getStats() {
                return {
                    steps: this.stepCount,
                    distance: this.totalDistance,
                    stepLength: this.stepLength,
                    isCalibrating: this.isCalibrating
                };
            }
        }

        // ========== ระบบนำทางและเป้าหมาย ==========
        class NavigationSystem {
            constructor() {
                this.params = new URLSearchParams(window.location.search);
                this.targetId = this.params.get('target') || 'TO_IT_BUILDING';
                this.targetAngle = parseFloat(this.params.get('angle')) || 0;
                this.targetDistance = parseFloat(this.params.get('dist')) || 200;
                this.guideText = decodeURIComponent(this.params.get('guide') || 'เดินตรงไปข้างหน้า');
                
                this.currentHeading = 0;
                this.targetReached = false;
                
                this.initUI();
            }

            initUI() {
                // อัพเดทชื่อเป้าหมาย
                const targetNameElement = document.getElementById('target-name');
                if (targetNameElement) {
                    const targetNames = {
                        'TO_IT_BUILDING': 'อาคารแผนกไอที',
                        'DEPT_LABEL_3': 'ป้ายแผนกไอที (ชั้น 3)',
                        'DEPT_LABEL_4': 'ป้ายแผนกไอที (ชั้น 4)',
                        '631': 'ห้องเรียน 631',
                        '632': 'ห้องเรียน 632',
                        '633': 'ห้องเรียน 633',
                        '634': 'ห้องเรียน 634',
                        '635': 'ห้องเรียน 635',
                        'TEACHER_ROOM': 'ห้องพักครู',
                        'LECTURE': 'ห้องแลคเชอร์',
                        'LAB1': 'ห้องแลป 1',
                        'LAB2': 'ห้องแลป 2',
                        'LAB3': 'ห้องแลป 3'
                    };
                    
                    targetNameElement.textContent = targetNames[this.targetId] || this.targetId;
                }
                
                // อัพเดทคำแนะนำ
                const guideTextElement = document.getElementById('guide-text');
                if (guideTextElement) {
                    guideTextElement.textContent = this.guideText;
                }
                
                // อัพเดทระยะทางที่เหลือ
                const remainingElement = document.getElementById('remaining-distance');
                if (remainingElement) {
                    remainingElement.textContent = this.targetDistance.toFixed(1) + 'm';
                }
                
                // เริ่มระบบคอมพาส
                this.initCompass();
            }

            initCompass() {
                if (typeof DeviceOrientationEvent !== 'undefined') {
                    window.addEventListener('deviceorientation', (event) => {
                        this.handleOrientation(event);
                    }, true);
                } else {
                    console.warn('Device Orientation not supported');
                }
            }

            handleOrientation(event) {
                if (event.alpha !== null) {
                    this.currentHeading = event.alpha;
                    
                    // อัพเดทเข็มทิศ
                    const compassNeedle = document.getElementById('compass-needle');
                    if (compassNeedle) {
                        compassNeedle.style.transform = `rotate(${this.currentHeading}deg)`;
                    }
                    
                    // อัพเดททิศทาง
                    const directionElement = document.getElementById('compass-direction');
                    if (directionElement) {
                        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                        const index = Math.round(this.currentHeading / 45) % 8;
                        directionElement.textContent = directions[index];
                    }
                    
                    // ตรวจสอบทิศทางไปยังเป้าหมาย
                    this.checkTargetDirection();
                }
            }

            checkTargetDirection() {
                const angleDiff = Math.abs(this.currentHeading - this.targetAngle);
                const normalizedDiff = Math.min(angleDiff, 360 - angleDiff);
                
                // ถ้าเดินผิดทิศทางเกิน 30 องศา
                if (normalizedDiff > 30 && !this.targetReached) {
                    this.showDirectionHint();
                }
            }

            showDirectionHint() {
                // แสดงคำแนะนำทิศทาง
                const guideTextElement = document.getElementById('guide-text');
                if (guideTextElement) {
                    const originalText = guideTextElement.textContent;
                    guideTextElement.innerHTML = `
                        <span style="color: #B8860B; font-weight: bold;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            โปรดปรับทิศทางไปยังเป้าหมาย
                        </span>
                        <br>
                        ${originalText}
                    `;
                    
                    // แจ้งเตือนด้วยการสั่น (ถ้ารองรับ)
                    if (window.navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }
                }
            }

            updateProgress(distanceTraveled) {
                const progress = Math.min((distanceTraveled / this.targetDistance) * 100, 100);
                
                // อัพเดท progress bar
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                // อัพเดทระยะทางที่เหลือ
                const remainingDistance = Math.max(this.targetDistance - distanceTraveled, 0);
                const remainingElement = document.getElementById('remaining-distance');
                if (remainingElement) {
                    remainingElement.textContent = remainingDistance.toFixed(1) + 'm';
                }
                
                // ตรวจสอบว่าถึงเป้าหมายแล้วหรือยัง
                if (remainingDistance <= 5 && !this.targetReached) {
                    this.onTargetReached();
                }
            }

            onTargetReached() {
                this.targetReached = true;
                
                // แสดงข้อความสำเร็จ
                const guideTextElement = document.getElementById('guide-text');
                if (guideTextElement) {
                    guideTextElement.innerHTML = `
                        <span style="color: #10B981; font-weight: bold; font-size: 18px;">
                            <i class="fas fa-check-circle"></i> 
                            ถึงเป้าหมายแล้ว!
                        </span>
                        <br>
                        คุณได้เดินทางถึงจุดหมายปลายทางแล้ว
                    `;
                }
                
                // แจ้งเตือนด้วยเสียงและสั่น
                if (window.navigator.vibrate) {
                    navigator.vibrate([300, 100, 300, 100, 300]);
                }
                
                // เล่นเสียง (ถ้ามี)
                this.playSuccessSound();
                
                // บันทึกสถิติ
                this.saveNavigationStats();
            }

            playSuccessSound() {
                // สร้างเสียงแจ้งเตือนด้วย Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 880;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1);
                } catch (error) {
                    console.log('Audio not supported');
                }
            }

            saveNavigationStats() {
                const stats = {
                    target: this.targetId,
                    timestamp: new Date().toISOString(),
                    distance: this.targetDistance,
                    completed: true
                };
                
                // บันทึกลง localStorage
                const navigationHistory = JSON.parse(localStorage.getItem('stc_navigation_history') || '[]');
                navigationHistory.push(stats);
                localStorage.setItem('stc_navigation_history', JSON.stringify(navigationHistory.slice(-50))); // เก็บ 50 รายการล่าสุด
            }
        }

        // ========== ระบบกล้อง ==========
        class CameraSystem {
            constructor() {
                this.videoElement = document.getElementById('camera-view');
                this.isCameraActive = false;
            }

            async initialize() {
                try {
                    // ขออนุญาตใช้กล้อง
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment', // ใช้กล้องหลัง
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: false
                    });
                    
                    this.videoElement.srcObject = stream;
                    this.isCameraActive = true;
                    
                    console.log('Camera activated successfully');
                    return true;
                } catch (error) {
                    console.error('Camera error:', error);
                    this.showCameraError();
                    return false;
                }
            }

            showCameraError() {
                // แสดงข้อความเมื่อกล้องไม่สามารถใช้งานได้
                const guideTextElement = document.getElementById('guide-text');
                if (guideTextElement) {
                    guideTextElement.innerHTML = `
                        <span style="color: #EF4444; font-weight: bold;">
                            <i class="fas fa-video-slash"></i> 
                            ไม่สามารถเข้าถึงกล้องได้
                        </span>
                        <br>
                        ระบบจะทำงานในโหมดนำทางโดยไม่ใช้ภาพจากกล้อง
                    `;
                }
                
                // ตั้งพื้นหลังสีแทนกล้อง
                document.getElementById('ar-container').style.background = 
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }

            stop() {
                if (this.videoElement.srcObject) {
                    const tracks = this.videoElement.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    this.videoElement.srcObject = null;
                }
            }
        }

        // ========== ระบบเสียงนำทาง ==========
        class VoiceGuidanceSystem {
            constructor() {
                this.isVoiceEnabled = false;
                this.speechSynth = window.speechSynthesis;
                this.voiceGuideBtn = document.getElementById('voice-guide-btn');
                
                if (this.voiceGuideBtn) {
                    this.voiceGuideBtn.addEventListener('click', () => this.toggleVoiceGuidance());
                }
            }

            toggleVoiceGuidance() {
                this.isVoiceEnabled = !this.isVoiceEnabled;
                
                if (this.isVoiceEnabled) {
                    this.voiceGuideBtn.innerHTML = '<i class="fas fa-volume-mute"></i> ปิดเสียง';
                    this.speak('เปิดใช้งานคำแนะนำเสียงนำทาง');
                } else {
                    this.voiceGuideBtn.innerHTML = '<i class="fas fa-volume-up"></i> คำแนะนำเสียง';
                    this.speak('ปิดคำแนะนำเสียงนำทาง');
                }
            }

            speak(text) {
                if (!this.isVoiceEnabled || !this.speechSynth) return;
                
                // ยกเลิกคำพูดก่อนหน้า
                this.speechSynth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                this.speechSynth.speak(utterance);
            }

            giveDirectionHint(direction) {
                if (!this.isVoiceEnabled) return;
                
                const directions = {
                    'left': 'กรุณาเลี้ยวซ้าย',
                    'right': 'กรุณาเลี้ยวขวา',
                    'straight': 'เดินตรงไปข้างหน้า',
                    'back': 'กรุณากลับหลัง'
                };
                
                this.speak(directions[direction] || 'กรุณาปรับทิศทาง');
            }
        }

        // ========== ระบบหลัก ==========
        class ARNavigationApp {
            constructor() {
                this.stepCounter = new StepCounterSystem();
                this.navigation = new NavigationSystem();
                this.camera = new CameraSystem();
                this.voiceGuidance = new VoiceGuidanceSystem();
                this.isInitialized = false;
            }

            async initialize() {
                console.log('Initializing AR Navigation App...');
                
                // เริ่มระบบต่างๆ
                await this.startSystems();
                
                // ซ่อน loading screen
                setTimeout(() => {
                    this.hideLoadingScreen();
                }, 2000);
                
                this.isInitialized = true;
            }

            async startSystems() {
                // เริ่มระบบกล้อง
                await this.camera.initialize();
                
                // เริ่มระบบนับก้าว
                this.stepCounter.initialize();
                
                // ฟังการเปลี่ยนแปลงจำนวนก้าว
                window.addEventListener('stepDetected', (event) => {
                    this.navigation.updateProgress(event.detail.distance);
                    
                    // ให้คำแนะนำเสียง (ถ้าเปิดใช้งาน)
                    if (event.detail.count % 20 === 0) { // ทุก 20 ก้าว
                        this.voiceGuidance.speak(`เดินไปแล้ว ${event.detail.count} ก้าว`);
                    }
                });
                
                // เริ่มต้นคำแนะนำ
                this.voiceGuidance.speak('เริ่มระบบนำทางแล้ว โปรดเดินไปตามทิศทางที่กำหนด');
            }

            hideLoadingScreen() {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }
            }

            cleanup() {
                // ทำความสะอาดทรัพยากร
                this.camera.stop();
                this.voiceGuidance.speechSynth.cancel();
                
                // บันทึกสถิติเมื่อออก
                if (this.stepCounter.stepCount > 0) {
                    const stats = {
                        steps: this.stepCounter.stepCount,
                        distance: this.stepCounter.totalDistance,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('stc_last_session', JSON.stringify(stats));
                }
            }
        }

        // ========== เริ่มต้นแอปพลิเคชัน ==========
        let app;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                app = new ARNavigationApp();
                await app.initialize();
                
                // ตั้งค่าเมื่อปิดหน้า
                window.addEventListener('beforeunload', () => {
                    if (app) {
                        app.cleanup();
                    }
                });
                
                // ตั้งค่าเมื่อเปลี่ยนแท็บ (สำหรับ mobile)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && app) {
                        app.cleanup();
                    }
                });
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                document.getElementById('loading-text').textContent = 
                    'เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message;
            }
        });

        // ========== ฟังก์ชันช่วยเหลือ ==========
        function updateLoadingText(text) {
            const element = document.getElementById('loading-text');
            if (element) element.textContent = text;
        }

        // ตรวจสอบการรองรับฟีเจอร์ต่างๆ
        function checkFeatures() {
            const features = {
                deviceMotion: 'ondevicemotion' in window,
                deviceOrientation: 'ondeviceorientation' in window,
                mediaDevices: 'mediaDevices' in navigator,
                vibration: 'vibrate' in navigator,
                speechSynthesis: 'speechSynthesis' in window
            };
            
            console.log('Feature support:', features);
            return features;
        }

        // เรียกตรวจสอบฟีเจอร์เมื่อโหลด
        setTimeout(checkFeatures, 1000);
    </script>
</body>
</html>
