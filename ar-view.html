<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Mission Control | STC IT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Sarabun:wght@300;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
        }

        body { font-family: 'Sarabun', sans-serif; background: #000; }
        .font-modern { font-family: 'Orbitron', sans-serif; }

        #video-preview {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            z-index: -100; object-fit: cover;
            filter: brightness(0.6) contrast(1.2);
        }

        .glass-panel {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .neon-border {
            border-left: 4px solid var(--neon-blue);
            box-shadow: -5px 0 15px rgba(0, 242, 255, 0.3);
        }

        .arrow-indicator {
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 15px var(--neon-blue));
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--neon-blue), transparent);
            position: absolute;
            opacity: 0.2;
            animation: scanning 4s linear infinite;
        }

        @keyframes scanning {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .dist-glow {
            text-shadow: 0 0 15px rgba(0, 242, 255, 0.8);
        }

        .pulse-soft {
            animation: pulse-soft 2s infinite;
        }

        @keyframes pulse-soft {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* ปุ่มสำรอง Manual Step */
        .manual-trigger {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 242, 255, 0.1);
            border: 2px solid rgba(0, 242, 255, 0.4);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
            transition: all 0.2s;
            z-index: 50;
        }

        .manual-trigger:active {
            transform: scale(0.9);
            background: rgba(0, 242, 255, 0.3);
        }

        .radar-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid var(--neon-blue);
            border-radius: 50%;
            animation: radar-ping 2s ease-out infinite;
        }

        @keyframes radar-ping {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body class="overflow-hidden text-white">

    <video id="video-preview" autoplay playsinline muted></video>
    <div class="scan-line"></div>

    <div class="relative h-screen flex flex-col justify-between p-4 md:p-8">
        
        <div class="glass-panel neon-border p-5 rounded-tr-3xl">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-2 h-2 bg-cyan-400 rounded-full animate-ping"></div>
                        <span class="font-modern text-[10px] tracking-[0.3em] text-cyan-400 uppercase">Mission Status: Active</span>
                    </div>
                    <h2 id="target-name" class="text-3xl font-black tracking-tight text-white uppercase italic">...</h2>
                </div>
                <button onclick="history.back()" class="text-white/30 hover:text-white transition-colors">
                    <i class="fa-solid fa-circle-xmark fa-2xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center relative">
            <div class="absolute w-64 h-64 border-2 border-dashed border-white/5 rounded-full animate-[spin_15s_linear_infinite]"></div>
            
            <button onclick="processStep();" class="manual-trigger">
                <div class="radar-circle"></div>
                <i class="fa-solid fa-shoe-prints text-cyan-400 text-xl"></i>
                <span class="text-[8px] font-bold text-cyan-200 mt-1 uppercase">Step</span>
            </button>

            <div id="arrow-container" class="arrow-indicator relative">
                <svg width="140" height="140" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" fill="url(#paint0_linear)" />
                    <defs>
                        <linearGradient id="paint0_linear" x1="12" y1="2" x2="12" y2="21" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#00f2ff" />
                            <stop offset="1" stop-color="#0066ff" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>

            <div class="mt-14">
                <div class="glass-panel px-10 py-3 rounded-full border border-cyan-500/20 pulse-soft">
                    <p id="guide-text" class="text-xs font-bold tracking-[0.2em] text-cyan-200 uppercase">Calibrating Environment...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="glass-panel p-6 rounded-bl-3xl relative overflow-hidden border-t-2 border-cyan-500/30">
                <p class="font-modern text-[9px] tracking-widest text-cyan-500/50 mb-2 font-bold">RANGE TO TARGET</p>
                <div class="flex items-baseline gap-1">
                    <span id="dist-remain" class="font-modern text-5xl font-black text-white dist-glow">0</span>
                    <span class="font-modern text-[10px] text-cyan-400">M.</span>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-br-3xl border-t-2 border-cyan-500/30">
                <p class="font-modern text-[9px] tracking-widest text-cyan-500/50 mb-2 font-bold">ENGINE STATUS</p>
                <div id="status-card" class="flex flex-col gap-1">
                    <div id="status-text" class="font-black text-[11px] flex items-center gap-2 text-amber-500 tracking-widest uppercase">
                        <i class="fa-solid fa-circle-notch animate-spin"></i> Offline
                    </div>
                    <div class="w-full bg-white/5 h-[2px] mt-3">
                        <div id="status-bar" class="bg-cyan-500 h-full w-0 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const targetRoom = params.get('target');
        const targetAngle = parseFloat(params.get('angle')) || 0;
        const initialGuide = params.get('guide');
        
        let currentDistance = parseFloat(params.get('dist')) || 0;
        let lastStepTime = 0;
        const stepLength = 0.65; 

        document.getElementById('target-name').innerText = targetRoom;
        document.getElementById('dist-remain').innerText = currentDistance.toFixed(1);

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                document.getElementById('video-preview').srcObject = stream;
            } catch (err) { console.error(err); }
        }

        function initSensors() {
            document.getElementById('guide-text').innerText = initialGuide;
            document.getElementById('status-text').innerHTML = '<i class="fa-solid fa-check-double"></i> Link Established';
            document.getElementById('status-text').className = "text-cyan-400 font-black text-[11px] tracking-widest uppercase";
            document.getElementById('status-bar').style.width = "100%";

            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') window.addEventListener('deviceorientation', handleOrientation);
                });
            } else {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
            }
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleOrientation(event) {
            let heading = event.webkitCompassHeading || (360 - event.alpha);
            if (heading) {
                let arrowRotation = targetAngle - heading;
                document.getElementById('arrow-container').style.transform = `rotate(${arrowRotation}deg)`;
            }
        }

        function handleMotion(event) {
            let acc = event.accelerationIncludingGravity;
            if (!acc) return;
            let magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            const now = Date.now();
            // 13.5 คือค่าความแรงก้าวเดินมาตรฐาน
            if (magnitude > 13.5 && (now - lastStepTime) > 450) {
                if (currentDistance > 0) {
                    processStep();
                    lastStepTime = now;
                }
            }
        }

        function processStep() {
            if (currentDistance <= 0) return;

            currentDistance -= stepLength;
            if (currentDistance < 0) currentDistance = 0;

            const distElement = document.getElementById('dist-remain');
            distElement.innerText = currentDistance.toFixed(1);
            
            // Visual feedback เมื่อมีการก้าวเดิน
            distElement.classList.add('scale-110', 'text-cyan-300');
            setTimeout(() => distElement.classList.remove('scale-110', 'text-cyan-300'), 150);

            if (currentDistance <= 0.8) {
                document.getElementById('guide-text').innerText = "ARRIVAL AT DESTINATION";
                document.getElementById('guide-text').parentElement.classList.replace('border-cyan-500/20', 'bg-cyan-500');
                document.getElementById('guide-text').classList.replace('text-cyan-200', 'text-black');
                if (window.navigator.vibrate) window.navigator.vibrate([200, 100, 200]);
            }
        }

        window.onload = startCamera;
        document.body.addEventListener('click', initSensors, { once: true });
    </script>
</body>
</html>
