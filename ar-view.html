<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Navigation View | วิทยาลัยเทคนิคสุราษฎร์ธานี</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #video-preview {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            width: auto; height: auto; z-index: -100;
            object-fit: cover;
        }
        .arrow-indicator {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-black overflow-hidden font-['Sarabun']">

    <video id="video-preview" autoplay playsinline muted></video>

    <div class="relative h-screen flex flex-col justify-between p-6">
        
        <div class="bg-white/90 backdrop-blur-md p-5 rounded-3xl shadow-2xl flex justify-between items-center border-b-4 border-purple-600">
            <div>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-black">กำลังนำทางไป</p>
                <h2 id="target-name" class="text-2xl font-black text-purple-900 leading-tight">...</h2>
            </div>
            <button onclick="history.back()" class="bg-red-50 text-red-500 w-12 h-12 rounded-2xl flex items-center justify-center shadow-inner">
                <i class="fa-solid fa-xmark fa-lg"></i>
            </button>
        </div>

        <div class="flex flex-col items-center justify-center">
            <div id="arrow-container" class="arrow-indicator">
                <i class="fa-solid fa-location-arrow text-8xl text-purple-500 drop-shadow-[0_0_20px_rgba(168,85,247,0.8)]"></i>
            </div>
            <div class="mt-10 bg-purple-900/90 text-white px-8 py-4 rounded-2xl backdrop-blur-md shadow-2xl border border-white/20 text-center">
                <p id="guide-text" class="text-lg font-bold">กรุณาแตะหน้าจอเพื่อเริ่มระบบ</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white/90 backdrop-blur-md p-5 rounded-3xl text-center shadow-2xl">
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">ระยะคงเหลือ</p>
                <p class="text-4xl font-black text-purple-600"><span id="dist-remain">0</span><span class="text-lg ml-1">ม.</span></p>
            </div>
            <div id="status-card" class="bg-white/90 backdrop-blur-md p-5 rounded-3xl text-center shadow-2xl transition-colors">
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">เซนเซอร์เดิน</p>
                <div id="status-text" class="text-amber-500 font-black text-lg">
                    <i class="fa-solid fa-pause-circle"></i> รอเริ่ม
                </div>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const targetRoom = params.get('target');
        const targetAngle = parseFloat(params.get('angle')) || 0;
        const initialGuide = params.get('guide');
        
        let currentDistance = parseFloat(params.get('dist')) || 0;
        let isMoving = false;
        let stepCount = 0;
        const stepLength = 0.65; // ความยาวก้าวเดินเฉลี่ย 0.65 เมตร

        // อัปเดต UI เริ่มต้น
        document.getElementById('target-name').innerText = "ห้อง " + targetRoom;
        document.getElementById('dist-remain').innerText = currentDistance.toFixed(1);

        // 1. ระบบกล้อง
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', focusMode: 'continuous' }, 
                    audio: false 
                });
                document.getElementById('video-preview').srcObject = stream;
            } catch (err) {
                console.error("Camera Error:", err);
            }
        }

        // 2. ระบบเข็มทิศ
        function initSensors() {
            document.getElementById('guide-text').innerText = initialGuide;
            document.getElementById('status-text').innerHTML = '<i class="fa-solid fa-person-walking"></i> พร้อมตรวจจับ';
            document.getElementById('status-text').className = "text-green-500 font-black text-lg";

            // ขอสิทธิ์ Device Orientation (สำหรับ iOS)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                });
            } else {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
            }

            // เริ่มระบบตรวจจับการเดิน
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleOrientation(event) {
            let heading = event.webkitCompassHeading || (360 - event.alpha);
            if (heading) {
                // คำนวณมุม: เป้าหมาย - ทิศเครื่องปัจจุบัน
                let arrowRotation = targetAngle - heading;
                document.getElementById('arrow-container').style.transform = `rotate(${arrowRotation}deg)`;
            }
        }

        // 3. ระบบตรวจจับการเดิน (Step Detection)
        let lastStepTime = 0;
        function handleMotion(event) {
            let acc = event.accelerationIncludingGravity;
            if (!acc) return;

            // คำนวณความแรงของการเคลื่อนที่ (Magnitude)
            let magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

            // ตรวจสอบแรงกระแทกที่สอดคล้องกับการก้าวเดิน (ค่าปกติประมาณ 12-14)
            // และเว้นระยะห่างระหว่างก้าวอย่างน้อย 400ms เพื่อไม่ให้นับซ้ำ
            const now = Date.now();
            if (magnitude > 13.5 && (now - lastStepTime) > 450) {
                if (currentDistance > 0) {
                    processStep();
                    lastStepTime = now;
                }
            }
        }

        function processStep() {
            // ลดระยะทาง
            currentDistance -= stepLength;
            if (currentDistance < 0) currentDistance = 0;

            // อัปเดตหน้าจอ
            const distElement = document.getElementById('dist-remain');
            distElement.innerText = currentDistance.toFixed(1);
            
            // เอฟเฟกต์เมื่อก้าวเดิน
            distElement.parentElement.classList.add('scale-110', 'text-purple-800');
            setTimeout(() => distElement.parentElement.classList.remove('scale-110', 'text-purple-800'), 200);

            // เมื่อถึงจุดหมาย
            if (currentDistance <= 0.8) {
                document.getElementById('guide-text').innerText = "คุณมาถึง " + targetRoom + " แล้ว";
                document.getElementById('guide-text').parentElement.className = "mt-10 bg-green-500 text-white px-8 py-4 rounded-2xl shadow-2xl pulse-animation";
                if (window.navigator.vibrate) window.navigator.vibrate([200, 100, 200]);
            }
        }

        window.onload = startCamera;
        // บังคับให้ user แตะก่อนเพื่อเปิดใช้งาน Sensor ตามกฎ Browser
        document.body.addEventListener('click', initSensors, { once: true });
    </script>
</body>
</html>
