<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Navigation - Real-time Tracking</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Sarabun', sans-serif; background: #000; }

        #ui-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.9); color: #fff; z-index: 10;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            border-bottom: 2px solid #3b82f6;
        }

        #ui-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 130px;
            background: rgba(0,0,0,0.9); color: #fff; z-index: 10;
            display: none; flex-direction: column;
            border-top: 2px solid #3b82f6;
        }

        #guidance-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; }
        #sensor-warning { background: #ffcc00; color: #000; padding: 5px; text-align: center; font-weight: 700; font-size: 0.8rem; }

        .label { font-size: 0.65rem; color: #3b82f6; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .target { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .step-text { font-size: 1.3rem; font-weight: 700; text-align: center; }

        a-scene { position: absolute; top: 0; left: 0; z-index: 1; }

        #entry-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; text-align: center; padding: 20px;
        }
        .start-btn {
            background: #3b82f6; color: white; padding: 20px 50px;
            border-radius: 50px; font-size: 1.5rem; font-weight: 700; border: none;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body>

    <div id="entry-screen">
        <h2 style="margin-bottom:10px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</h2>
        <p style="margin-bottom:30px; opacity:0.8;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏≠‡∏ó‡∏µ<br>‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô</p>
        <button class="start-btn" onclick="initPrecisionAR()">START</button>
    </div>

    <div id="ui-header">
        <div class="label">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
        <div id="room-id" class="target">...</div>
    </div>

    <div id="ui-footer">
        <div id="guidance-content">
            <div class="label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <span id="instruction-text" class="step-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
        </div>
        <div id="sensor-warning">
            ‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏£‡∏ß‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏≤‡∏° "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
        </div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-entity camera id="fixed-camera"></a-entity>
        
        <a-entity id="arrow-pivot" position="0 -0.8 -3" visible="false">
            <a-entity id="arrow-visual">
                <a-cone radius-bottom="0.25" height="0.5" material="color: #3b82f6; emissive: #3b82f6; emissiveIntensity: 1;" rotation="90 0 0"></a-cone>
                <a-box position="0 -0.3 0" width="0.12" height="0.4" depth="0.1" material="color: #1e3a8a;"></a-box>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetRoom = urlParams.get('target') || '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
        const guideLabel = urlParams.get('guide') || '‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡πÑ‡∏õ';
        const targetAngle = parseFloat(urlParams.get('angle')) || 0;
        
        let remainingDist = parseFloat(urlParams.get('dist')) || 0;
        let initialAlpha = null;
        let currentDeviceAlpha = 0;
        let lerpedRotY = 0;
        const smoothSpeed = 0.15;

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡πâ‡∏≤‡∏ß‡πÄ‡∏î‡∏¥‡∏ô (Step Detection) ---
        let lastAccel = 0;
        const stepThreshold = 12.5; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πâ‡∏≤‡∏ß (‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏π‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á)
        const stepLength = 0.7; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡πâ‡∏≤‡∏ß‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 0.7 ‡πÄ‡∏°‡∏ï‡∏£

        document.getElementById('room-id').innerText = targetRoom;

        async function initPrecisionAR() {
            // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Sensor ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS/Android ‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const res = await DeviceOrientationEvent.requestPermission();
                const res2 = await DeviceMotionEvent.requestPermission();
                if (res === 'granted' && res2 === 'granted') {
                    startSensors();
                }
            } else {
                startSensors();
            }
            showUI();
            updateDisplay();
        }

        function startSensors() {
            window.addEventListener('deviceorientation', (e) => {
                if (e.alpha !== null) {
                    if (initialAlpha === null) initialAlpha = e.alpha;
                    currentDeviceAlpha = e.alpha;
                }
            });

            window.addEventListener('devicemotion', (e) => {
                const acc = e.accelerationIncludingGravity;
                if (!acc) return;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏£‡∏á‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô
                const magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                const delta = Math.abs(magnitude - lastAccel);

                if (delta > stepThreshold) {
                    if (remainingDist > 0) {
                        remainingDist -= stepLength;
                        if (remainingDist < 0) remainingDist = 0;
                        updateDisplay();
                    }
                }
                lastAccel = magnitude;
            });
        }

        function updateDisplay() {
            const display = document.getElementById('instruction-text');
            if (remainingDist <= 0) {
                display.innerHTML = "üìç <span style='color:#22c55e'>‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>";
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            } else {
                display.innerText = `üö∂ ${guideLabel} (${remainingDist.toFixed(1)} ‡∏°.)`;
            }
        }

        function showUI() {
            document.getElementById('entry-screen').style.display = 'none';
            document.getElementById('ui-header').style.display = 'flex';
            document.getElementById('ui-footer').style.display = 'flex';
            document.getElementById('arrow-pivot').setAttribute('visible', 'true');
        }

        function animate() {
            if (initialAlpha !== null) {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏á‡∏®‡∏≤: (‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) + ‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                let targetY = (currentDeviceAlpha - initialAlpha) + targetAngle;
                
                let diff = targetY - lerpedRotY;
                while (diff < -180) diff += 360;
                while (diff > 180) diff -= 360;
                lerpedRotY += diff * smoothSpeed;

                const pivot = document.getElementById('arrow-pivot');
                if (pivot) {
                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö A-Frame
                    pivot.object3D.rotation.y = THREE.MathUtils.degToRad(-lerpedRotY);
                }
            }
            requestAnimationFrame(animate);
        }
        
        animate();
    </script>
</body>
</html>
